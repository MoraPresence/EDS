#include "stribog_alg.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <math.h>
#include "stribog_data.h"

void X(const void *a, const void *b, void *c) {
    int i = 0;
    const uint512 *A = a, *B = b;
    uint512 *C = c;

    C->qw[0] = A->qw[0] ^ B->qw[0];
    C->qw[1] = A->qw[1] ^ B->qw[1];
    C->qw[2] = A->qw[2] ^ B->qw[2];
    C->qw[3] = A->qw[3] ^ B->qw[3];
    C->qw[4] = A->qw[4] ^ B->qw[4];
    C->qw[5] = A->qw[5] ^ B->qw[5];
    C->qw[6] = A->qw[6] ^ B->qw[6];
    C->qw[7] = A->qw[7] ^ B->qw[7];
}

void S(uint512 *a) {
    int i = 0;
    for (i = 0; i < 64; ++i) {
        a->b[i] = pi[a->b[i]];
    }
}

void L(unsigned char *a) {
    unsigned long long v = 0;
    int i = 0, j = 0, k = 0;

    for (i = 0; i < 8; i++) {
        v = 0;
        for (k = 0; k < 8; k++) {
            for (j = 0; j < 8; j++) {
                if ((a[i * 8 + k] & (1 << (7 - j))) != 0)
                    v ^= A[k * 8 + j];
            }
        }
        for (k = 0; k < 8; k++) {
            a[i * 8 + k] = (v & ((unsigned long long) 0xFF << (7 - k) * 8)) >> (7 - k) * 8;
        }
    }
}

void P(unsigned char *a) {
    int i = 0;
    unsigned char tmp[64] = {};

    for (i = 0; i < 64; i++) {
        tmp[i] = a[Tau[i]];
    }
    memcpy(a, tmp, 64);
}

void KeyTable(unsigned char *K, int i) {
    X(K, C[i], K);
    S(K);
    P(K);
    L(K);
}

void E(unsigned char *K, const unsigned char *m, unsigned char *result) {
    int i = 0;
    X(m, K, result);
    for (i = 0; i < 12; ++i) {
        S(result);
        P(result);
        L(result);
        KeyTable(K, i);
        X(result, K, result);
    }
}

void g_N(const unsigned char *N, unsigned char *h, const unsigned char *m) {
    uint512 resE, K;
    X(h, N, &K);
    S(&K);
    P((unsigned char *) &K);
    L((unsigned char *) &K);
    E((unsigned char *) &K, m, (unsigned char *) &resE);
    X(&resE, h, &resE);
    X(&resE, m, h);
}

void add512(const unsigned char *a, const unsigned char *b, unsigned char *c) {
    int i = 0, tmp = 0;

    for (i = 63; i >= 0; i--) {
        tmp = a[i] + b[i] + (tmp >> 8);
        c[i] = tmp & 0xFF;
    }
}

void hash_XXX(unsigned char *IV, const unsigned char *message, unsigned long long length, unsigned char *out) {
    unsigned char v512[64] = {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    unsigned char v0[64] = {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    unsigned char Sigma[64] = {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    unsigned char N[64] = {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    unsigned char m[64], *hash = IV;
    unsigned long long len = length;

    while (len >= 512) {
        memcpy(m, message + len / 8 - 63 - ((len & 0x7) == 0), 64);
        g_N(N, hash, m);
        add512(N, v512, N);
        add512(Sigma, m, Sigma);
        len = len - 512;
    }
    memset(m,0,64);
    memcpy(m + 63 - len/8 + ( (len & 0x7) == 0 ), message, len/8 + 1 - ( (len & 0x7) == 0 ));
    m[ 63 - len/8 ] |= (1 << (len & 0x7));

    g_N(N, hash, m);
    v512[63] = len & 0xFF;
    v512[62] = len >> 8;
    add512(N,v512,N);
    add512(Sigma,m,Sigma);
    g_N(v0,hash,N);
    g_N(v0,hash,Sigma);

    memcpy(out, hash, 64);
}

void hash_512(const unsigned char *message, unsigned long long length, unsigned char *out) {
    unsigned char IV[64] =
            {
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
            };

    hash_XXX(IV, message, length, out);
}

void hash_256(const unsigned char *message, unsigned long long length, unsigned char *out) {
    unsigned char IV[64] =
            {
                    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
                    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
                    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
                    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01
            };
    unsigned char hash[64];

    hash_XXX(IV, message, length, hash);

    memcpy(out, hash, 32);
}